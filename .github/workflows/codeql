# CodeQL Workflow for Advanced Security Analysis
# This configuration automates security scanning using CodeQL.
# Please review the documentation for detailed customization options:
# https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/customizing-your-advanced-setup-for-code-scanning

name: "CodeQL Advanced Security Analysis"

on:
  push:
    branches:
      - "main"  # Trigger the workflow on push to the main branch
  pull_request:
    branches:
      - "main"  # Trigger the workflow on pull requests targeting the main branch
  schedule:
    # Run the CodeQL scan every Monday at 18:17 UTC
    - cron: '17 18 * * 1'

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    # Runners are selected based on the programming language to ensure compatibility
    runs-on: ${{ (matrix.language == 'swift' && 'macos-latest') || 'ubuntu-latest' }}
    
    permissions:
      # Essential permissions for CodeQL scans
      security-events: write      # Write access to security events (for alerts)
      packages: read              # Read access to dependencies (CodeQL packs)
      actions: read               # Read access to Actions (needed for private repos)
      contents: read              # Read access to repository content

    strategy:
      fail-fast: false  # Ensure the workflow continues even if one of the languages fails
      matrix:
        include:
          - language: c-cpp               # C and C++ analysis
            build-mode: autobuild         # Automatic build detection
          - language: javascript-typescript  # JavaScript and TypeScript analysis
            build-mode: none              # No build required for JS/TS
          - language: python              # Python analysis
            build-mode: none              # No build required for Python

        # Note: For compiled languages, set build-mode to 'manual' if auto-build fails
        # Further documentation: https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/codeql-code-scanning-for-compiled-languages

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4  # Checkout the repository to analyze its code

    # Initialize CodeQL for scanning the selected language
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}       # Select languages based on the matrix
        build-mode: ${{ matrix.build-mode }}     # Choose the build mode for each language
        # You can also specify custom queries for further analysis
        # Example: queries: "security-extended,security-and-quality"

    # If the build mode is manual, the following step will build the code
    - if: matrix.build-mode == 'manual'
      shell: bash
      run: |
        echo 'If using manual build mode, replace this with your build commands, for example:'
        echo '  make bootstrap'
        echo '  make release'
        exit 1

    # Perform CodeQL Analysis for the selected language
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{ matrix.language }}"  # Category for organizing the analysis results

